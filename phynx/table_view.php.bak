<?php
// Include the functions api
// include 'includes/config/funcs.api.php';

// Get the variables for the tables
$page = $_GET['page'] ?? 'browse';
$edit_id = $_GET['edit'] ?? '';
$delete_id = $_GET['delete'] ?? '';
$message = '';
$data = [];

// Get connection info
$connection_info = $conn->host_info;

if ($selected_table) {
    // Get table structure
    $structure = functions::getTableStructure($conn, $selected_table);
    $columns = $structure['columns'];
    $primary_key = $structure['primary_key'];

    // Handle form submissions
    if ($_POST) {
        if (isset($_POST['update']) && $edit_id && $primary_key) {
            // Update the table row
            $success = functions::updateTableRow($conn, $selected_table, $_POST['update'], $primary_key, $edit_id);
            $message = $success ? "Row updated successfully!" : "ERROR: {$conn->error}.";
        } elseif (isset($_POST['insert'])) {
            // Insert a new table row
            $insert_data = $_POST['insert'] ?? [];
            
            // Handle case where insert is not an array
            if (!is_array($insert_data)) {
                $insert_data = [];
            }
            
            // Remove empty values and handle null checkboxes
            $filtered_data = [];
            if (is_array($insert_data)) {
                foreach ($insert_data as $field => $value) {
                    // Skip if null checkbox is checked
                    if (isset($_POST['null'][$field])) {
                        continue;
                    }
                    // Only include non-empty values
                    if ($value !== '' && $value !== null) {
                        $filtered_data[$field] = $value;
                    }
                }
            }
            
            if (empty($filtered_data)) {
                $message = "ERROR: No data to insert. The form inputs may not be working properly.";
            } else {
                $success = functions::insertTableRow($conn, $selected_table, $filtered_data);
                if ($success) {
                    $message = "Row inserted successfully!";
                } else {
                    $message = "ERROR: " . ($conn->error ?: "Insert failed.");
                }
            }
        } elseif (isset($_POST['value'])) {
            // Search functionality
            $conditions = [];
            foreach ($_POST['value'] as $field => $value) {
                if (!empty($value)) {
                    $operator = $_POST['operator'][$field] ?? '=';
                    $escaped_value = $conn->real_escape_string($value);
                    if ($operator === 'LIKE') {
                        $conditions[] = "`$field` LIKE '%$escaped_value%'";
                    } else {
                        $conditions[] = "`$field` $operator '$escaped_value'";
                    }
                }
            }

            if ($conditions) {
                $where_clause = implode(' AND ', $conditions);
                $result = $conn->query("SELECT * FROM `$selected_table` WHERE $where_clause LIMIT 30");
                if ($result) {
                    while ($row = $result->fetch_assoc()) {
                        $data[] = $row;
                    }
                }
            }
        }
    }

    // HHandle delete
    if ($delete_id && $primary_key) {
        $success = functions::deleteTableRow($conn, $selected_table, $primary_key, $delete_id);
        $message = $success ? "Row deleted successfully!" : "ERROR: {$conn->error}.";
    }

    // Get edit row data
    $edit_row = [];
    if ($edit_id && $primary_key) {
        $escaped_id = $conn->real_escape_string($edit_id);
        $result = $conn->query("SELECT * FROM `$selected_table` WHERE `$primary_key` = '$escaped_id'");
        if ($result && $result->num_rows > 0) {
            $edit_row = $result->fetch_assoc();
        }
    }

    // Get table data for browse page
    if (($page === 'browse' || !$page) && empty($data) && !$_POST && !$edit_id) {
        $data = functions::getTableData($conn, $selected_table);
    }
}
?>

<div class="content-header">
    <h2>Table: <?= htmlspecialchars($selected_table); ?></h2>
    <div class="breadcrumb">
        <?= $connection_info; ?>
        <i class="fas fa-angle-right"></i>
        <span class="breadcrumb_text"><i class="fas fa-database"></i> <?= htmlspecialchars($selected_db); ?></span>
    </div>
</div>

<div class="tabs">
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>" class="tab <?= ($page === 'browse' || !$page) ? 'active' : ''; ?>">
        <i class="fas fa-browser"></i> Browse
    </a>
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=structure" class="tab <?= $page === 'structure' ? 'active' : ''; ?>">
        <i class="fas fa-table"></i> Structure
    </a>
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=sql" class="tab <?= $page === 'sql' ? 'active' : ''; ?>">
        <i class="fas fa-code"></i> SQL
    </a>
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=search" class="tab <?= $page === 'search' ? 'active' : ''; ?>">
        <i class="fas fa-search"></i> Search
    </a>
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=insert" class="tab <?= $page === 'insert' ? 'active' : ''; ?>">
        <i class="fas fa-plus"></i> Insert
    </a>
    <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=operations" class="tab <?= $page === 'operations' ? 'active' : ''; ?>">
        <i class="fas fa-clipboard-list"></i> Operations
    </a>
</div>

<?php if ($message): ?>
    <div class="info-box <?= strpos($message, 'ERROR:') === 0 ? 'error-message' : 'success-message'; ?>">
        <?= htmlspecialchars($message); ?>
    </div>
<?php endif; ?>

<?php if ($edit_id && $edit_row): ?>
    <h3>Edit Row</h3>
    <form method="POST">
        <table>
            <tr>
                <th>Column</th>
                <th>Type</th>
                <th>Value</th>
            </tr>
            <?php foreach ($columns as $column): ?>
                <tr>
                    <td><?= htmlspecialchars($column['Field']); ?></td>
                    <td><?= htmlspecialchars($column['Type']); ?></td>
                    <td>
                        <input type="text" name="update[<?= $column['Field']; ?>]" value="<?= htmlspecialchars($edit_row[$column['Field']] ?? '') ?>">
                    </td>
                </tr>
            <?php endforeach; ?>
        </table><br />
        <button type="submit" class="btn">Update</button>
        <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>" class="btn" style="background: var(--text-muted);">Cancel</a>
    </form>

<?php elseif ($page === 'structure'): ?>
    <div class="table-actions">
        <div class="action-buttons">
            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=add_column" class="btn">
                <i class="fas fa-plus"></i> Add Column
            </a>
            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=add_index" class="btn">
                <i class="fas fa-key"></i> Add Index
            </a>
            <button onclick="checkAllColumns()" class="btn">
                <i class="fas fa-check-square"></i> Check All
            </button>
        </div>
    </div>

    <form method="POST" action="">
        <table class="data-table">
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleAllColumns(this)"></th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Null</th>
                    <th>Default</th>
                    <th>Extra</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($columns as $row): ?>
                    <tr>
                        <td><input type="checkbox" name="columns[]" value="<?= $row['Field']; ?>"></td>
                        <td><strong><?= htmlspecialchars($row['Field']); ?></strong></td>
                        <td><?= htmlspecialchars($row['Type']); ?></td>
                        <td><?= $row['Null'] === 'YES' ? 'Yes' : 'No'; ?></td>
                        <td><?= htmlspecialchars($row['Default'] ?? 'None'); ?></td>
                        <td><?= htmlspecialchars($row['Extra']); ?></td>
                        <td>
                            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=edit_column&column=<?= urlencode($row['Field']); ?>" title="Edit" class="btn">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=drop_column&column=<?= urlencode($row['Field']); ?>" title="Drop" class="btn" onclick="return confirm('Drop column <?= $row['Field'] ?>?')">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>

        <div class="bulk-actions">
            <label>With Selected:</label>
            <select name="bulk_action">
                <option value="">-- Choose Action --</option>
                <option value="drop">Drop</option>
                <option value="primary">Set Primary Key</option>
                <option value="index">Add Index</option>
                <option value="unique">Unique</option>
            </select>
            <button type="submit" name="execute_bulk" class="btn">Go</button>
        </div>
    </form>

<?php elseif ($page === 'sql'): ?>
    <div class="sql-editor">
        <form method="POST">
            <textarea name="sql" placeholder="SELECT * FROM `<?= htmlspecialchars($selected_table); ?>`;"><?= $_POST['sql'] ?? ''; ?></textarea>
            <br /><br />
            <button type="submit" name="execute_sql" class="btn">Go</button>
        </form>
    </div>

    <?php if ($_POST['sql'] ?? ''): ?>
        <?php
        $result = $conn->query($_POST['sql']);
        if ($result && $result->num_rows > 0) {
            $sql_result = [];
            while ($row = $result->fetch_assoc()) {
                $sql_result[] = $row;
            }
            
            if ($sql_result):
        ?>
        <table>
            <thead>
                <tr>
                    <?php foreach (array_keys($sql_result[0]) as $column): ?>
                        <th><?= htmlspecialchars($column); ?></th>
                    <?php endforeach; ?>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($sql_result as $row): ?>
                    <tr>
                        <?php foreach ($row as $value): ?>
                            <td><?= htmlspecialchars($value ?? ''); ?></td>
                        <?php endforeach; ?>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <?php endif; ?>
        <?php } elseif ($conn->error) { ?>
        <div class="error-message">
            ERROR: <?= htmlspecialchars($conn->error); ?>
        </div>
        <?php } ?>
    <?php endif; ?>

<?php elseif ($page === 'search'): ?>
    <form method="POST">
        <table>
            <?php foreach ($columns as $column): ?>
                <tr>
                    <td><?= htmlspecialchars($column['Field']); ?></td>
                    <td>
                        <select name="operator[<?= $column['Field']; ?>]">
                            <option value="=">=</option>
                            <option value="LIKE">LIKE</option>
                            <option value=">">></option>
                            <option value="<"><</option>
                        </select>
                    </td>
                    <td><input type="text" name="value[<?= $column['Field']; ?>]"></td>
                </tr>
            <?php endforeach; ?>
        </table>
        <button type="submit" name="search" class="btn">
            <i class="fas fa-search"></i> Search
        </button>
    </form>

<?php elseif ($page === 'insert'): ?>
    <h3>Insert a New Row</h3>
    <form method="POST">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Column</th>
                    <th>Type</th>
                    <th>Function</th>
                    <th>Null</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($columns as $column): ?>
                    <tr>
                        <td><strong><?= htmlspecialchars($column['Field']); ?></strong></td>
                        <td><?= htmlspecialchars($column['Type']); ?></td>
                        <td>
                            <select>
                                <option value="">--</option>
                                <option>ABS</option>
                                <option>ACOS</option>
                                <option>AES_DECRYPT</option>
                                <option>AES_ENCRYPT</option>
                                <option>ASCII</option>
                                <option>ASIN</option>
                                <option>ATAN</option>
                                <option>BIN</option>
                                <option>BIT_COUNT</option>
                                <option>BIT_LENGTH</option>
                                <option>CEILING</option>
                                <option>CHAR</option>
                                <option>CHAR_LENGTH</option>
                                <option>COMPRESS</option>
                                <option>CONNECTION_ID</option>
                                <option>COS</option>
                                <option>COT</option>
                                <option>CRC32</option>
                                <option>CURRENT_DATE</option>
                                <option>CURRENT_TIME</option>
                                <option>CURRENT_USER</option>
                                <option>DATABASE</option>
                                <option>DATE</option>
                                <option>DAYNAME</option>
                                <option>DAYOFMONTH</option>
                                <option>DAYOFWEEK</option>
                                <option>DAYOFYEAR</option>
                                <option>DEGREES</option>
                                <option>DES_DECRYPT</option>
                                <option>DES_ENCRYPT</option>
                                <option>ENCRYPT</option>
                                <option>EXP</option>
                                <option>FLOOR</option>
                                <option>FROM_DAYS</option>
                                <option>FROM_UNIXTIME</option>
                                <option>HEX</option>
                                <option>HOUR</option>
                                <option>INET6_ATON</option>
                                <option>INET6_NTOA</option>
                                <option>INET_ATON</option>
                                <option>INET_NTOA</option>
                                <option>LAST_DAY</option>
                                <option>LENGTH</option>
                                <option>LN</option>
                                <option>LOAD_FILE</option>
                                <option>LOG</option>
                                <option>LOG10</option>
                                <option>LOG2</option>
                                <option>LOWER</option>
                                <option>LTRIM</option>
                                <option>MD5</option>
                                <option>MICROSECOND</option>
                                <option>MINUTE</option>
                                <option>MONTH</option>
                                <option>MONTHNAME</option>
                                <option>NOW</option>
                                <option>OCT</option>
                                <option>OLD_PASSWORD</option>
                                <option>ORD</option>
                                <option>PASSWORD</option>
                                <option>PI</option>
                                <option>QUARTER</option>
                                <option>QUOTE</option>
                                <option>RADIANS</option>
                                <option>RAND</option>
                                <option>REVERSE</option>
                                <option>ROUND</option>
                                <option>RTRIM</option>
                                <option>SECOND</option>
                                <option>SEC_TO_TIME</option>
                                <option>SHA1</option>
                                <option>SIGN</option>
                                <option>SIN</option>
                                <option>SOUNDEX</option>
                                <option>SPACE</option>
                                <option>SQRT</option>
                                <option>SYSDATE</option>
                                <option>TAN</option>
                                <option>TIME</option>
                                <option>TIMESTAMP</option>
                                <option>TIME_TO_SEC</option>
                                <option>TO_DAYS</option>
                                <option>TO_SECONDS</option>
                                <option>TRIM</option>
                                <option>UNCOMPRESS</option>
                                <option>UNCOMPRESSED_LENGTH</option>
                                <option>UNHEX</option>
                                <option>UNIX_TIMESTAMP</option>
                                <option>UPPER</option>
                                <option>USER</option>
                                <option>UTC_DATE</option>
                                <option>UTC_TIME</option>
                                <option>UTC_TIMESTAMP</option>
                                <option>UUID</option>
                                <option>UUID_SHORT</option>
                                <option>VERSION</option>
                                <option>WEEK</option>
                                <option>WEEKDAY</option>
                                <option>WEEKOFYEAR</option>
                                <option>YEAR</option>
                                <option>YEARWEEK</option>
                                <option value="PHP_PASSWORD_HASH" title="The PHP function password_hash() with default options.">password_hash() PHP function</option>
                            </select>
                        </td>
                        <td>
                            <?php if ($column['Null'] === 'YES'): ?>
                                <input type="checkbox" name="null[<?= $column['Field']; ?>]" value="1" onchange="toggleNullValue(this, '<?= $column['Field']; ?>')">
                            <?php else: ?>
                                <span>-</span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <?php if (strpos($column['Type'], 'enum') === 0): ?>
                                <?php
                                // Extract ENUM values
                                preg_match_all("/'([^']+)'/", $column['Type'], $matches);
                                $enum_values = $matches[1];
                                ?>
                                <select name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field'] ?>">
                                    <option value="">-- Select --</option>
                                    <?php foreach ($enum_values as $enum_value): ?>
                                        <option value="<?= htmlspecialchars($enum_value); ?>"><?= htmlspecialchars($enum_value); ?></option>
                                    <?php endforeach; ?>
                                </select>
                            <?php elseif (strpos($column['Type'], 'text') !== false): ?>
                                <textarea name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field']; ?>" rows="3" cols="30"></textarea>
                            <?php elseif (strpos($column['Type'], 'date') !== false): ?>
                                <input type="date" name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field']; ?>">
                            <?php elseif (strpos($column['Type'], 'time') !== false): ?>
                                <input type="time" name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field']; ?>">
                            <?php elseif (strpos($column['Type'], 'datetime') !== false || strpos($column['Type'], 'timestamp') !== false): ?>
                                <div class="datetime-picker">
                                    <input type="text" name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field']; ?>" placeholder="MM-DD-YYY HH:MM:SS">
                                    <i class="fas fa-calendar-alt datetime-icon" onclick="toggleDateTimePicker('<?= $column['Field']; ?>')"></i>

                                    <div id="datetime-popup-<?= $column['Field']; ?>" class="datetime-popup" style="display: none;">
                                        <div class="date-section">
                                            <div class="date-controls">
                                                <select id="monoth-select-<?= $column['Field']; ?>">
                                                    <option value="0">January</option>
                                                    <option value="1">February</option>
                                                    <option value="2">March</option>
                                                    <option value="3">April</option>
                                                    <option value="4">May</option>
                                                    <option value="5">June</option>
                                                    <option value="6">July</option>
                                                    <option value="7">August</option>
                                                    <option value="8">September</option>
                                                    <option value="9">October</option>
                                                    <option value="10">November</option>
                                                    <option value="11">December</option>
                                                </select>
                                                <select id="year-select-<?= $column['Field']; ?>"></select>
                                            </div>
                                            <div class="calendar-grid">
                                                <div class="day-headers">
                                                    <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                                                </div>
                                                <div id="calendar-days-<?= $column['Field']; ?>"></div>
                                            </div>
                                        </div>
                                        <div class="time-section">
                                            <div class="current-time" id="current-time-<?= $column['Field']; ?>"></div>
                                            <div class="time-sliders">
                                                <label>Hour: <input type="range" id="hour-slider-<?= $column['Field']; ?>" min="0" max="23" value="0"></label>
                                                <label>Minute: <input type="range" id="minute-slider-<?= $column['Field']; ?>" min="0" max="59" value="0"></label>
                                                <label>Second: <input type="range" id="second-slider-<?= $column['Field']; ?>" min="0" max="59" value="0"></label>
                                            </div>
                                            <select id="timezone-select-<?= $column['Field']; ?>">
                                                <option value="EST">EST</option>
                                                <option value="PST">PST</option>
                                                <option value="CST">CST</option>
                                                <option value="MST">MST</option>
                                                <option value="UTC">UTC</option>
                                            </select>
                                        </div>

                                        <button type="button" onclick="applyDateTime('<?= $column['Field']; ?>')" class="btn">Apply</button>
                                    </div>
                                </div>
                            <?php else: ?>
                                <input type="text" name="insert[<?= $column['Field']; ?>]" id="value_<?= $column['Field']; ?>" value="<?= htmlspecialchars($column['Default'] ?? ''); ?>" placeholder="<?=htmlspecialchars($column['Type']); ?>">
                            <?php endif; ?>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table><br />
        <button type="submit" name="insert" class="btn">
            <i class="fas fa-plus"></i> Insert
        </button>
        <button type="reset" name="reset" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i> Reset
        </button>
    </form>

<?php else: ?>
    <!-- BROWSE VIEW -->
    <div class="table-actions">
        <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&page=insert" class="btn">
            <i class="fas fa-plus"></i> Insert
        </a>
    </div>

    <?php if ($data): ?>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Action</th>
                    <?php foreach (array_keys($data[0]) as $column): ?>
                        <th><?= htmlspecialchars($column); ?></th>
                    <?php endforeach; ?>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($data as $row): ?>
                    <tr>
                        <td>
                            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&edit=<?= urlencode($row[$primary_key] ?? ''); ?>">Edit</a>
                            <a href="?db=<?= urlencode($selected_db); ?>&table=<?= urlencode($selected_table); ?>&delete=<?= urlencode($row[$primary_key] ?? ''); ?>" onclick="return confirm('Delete this row?')">Delete</a>
                        </td>
                        <?php foreach ($row as $value): ?>
                            <td><?= htmlspecialchars($value ?? ''); ?></td>
                        <?php endforeach; ?>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php else: ?>
        <p>No data found in the table.</p>
    <?php endif; ?>
<?php endif; ?>